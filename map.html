<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Map with Responsive Collapsible Legend Drawer</title>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }

      #appContainer {
        display: flex;
        height: 100%;
        width: 100%;
      }

      /* Map container */
      #viewDiv {
        flex: 1;
        transition: flex 0.3s ease; /* Smooth resizing effect */
      }

      #viewDiv.expanded {
        flex: 1 1 100%; /* Expand the map when the drawer is closed */
      }

      /* Toggle button for reopening the legend */
      #toggleButton {
        position: absolute;
        top: 50%;
        left: 0;
        transform: translate(-100%, -50%);
        background: #f4f4f4;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px;
        cursor: pointer;
        display: none; /* Hidden by default */
        z-index: 20;
      }

      #toggleButton.visible {
        display: block; /* Show the button when the legend is collapsed */
      }
    </style>

    <!-- Load the ArcGIS Maps SDK for JavaScript -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.32/"></script>

    <!-- Load Calcite Components -->
    <link rel="stylesheet" href="https://js.arcgis.com/calcite-components/2.7.1/calcite.css" />
    <script type="module" src="https://js.arcgis.com/calcite-components/2.7.1/calcite.esm.js"></script>
    <script nomodule src="https://js.arcgis.com/calcite-components/2.7.1/calcite.js"></script>
    <!-- ArcGIS Web Components -->
    <script type="module" src="https://js.arcgis.com/map-components/4.32/arcgis-map-components.esm.js"></script>
  </head>

  <body>
    <div id="appContainer">
      <!-- Floating Calcite Panel for Legend -->
      <calcite-panel id="legendPanel" width-scale="s" style="position:absolute;top:90px;left:16px;z-index:100;min-width:220px;max-width:350px;box-shadow:0 2px 6px rgba(0,0,0,0.15);background:white;max-height:none;height:auto;padding-bottom:8px;">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:0 1rem 0 0.5rem;">
          <span style="font-weight:bold;font-size:1.1em;">Legend</span>
          <calcite-action id="collapseLegend" icon="x" text="Close Legend" scale="s"></calcite-action>
        </div>
        <div id="legendContent"></div>
      </calcite-panel>
      <!-- Map container -->
      <div id="viewDiv" style="flex:1;position:relative;"></div>
      <!-- ArcGIS Scale Bar Web Component -->
      <arcgis-scale-bar id="webScaleBar" style="position:absolute;bottom:16px;left:16px;z-index:99;" bar-style="ruler" unit="imperial"></arcgis-scale-bar>
    </div>
    <!-- Legend expand button, styled like a map widget -->
    <div id="expandLegendContainer"></div>
    <calcite-action id="expandLegend" icon="legend" text="Show Legend" scale="s" style="display:none;box-shadow:0 2px 6px rgba(0,0,0,0.15);border-radius:6px;background:white;"></calcite-action>

    <script>
      require([
        "esri/config",
        "esri/WebMap",
        "esri/views/MapView",
        "esri/widgets/Legend",
        // "esri/widgets/ScaleBar", // Remove old ScaleBar import
        "esri/geometry/Extent"
      ], function (esriConfig, WebMap, MapView, Legend, Extent) {
        // Helper function to parse URL parameters
        function getUrlParams() {
          const params = new URLSearchParams(window.location.search);
          return {
            project: params.get("project"),
            itemId: params.get("itemId"),
            center: params.get("center") ? params.get("center").split(",").map(Number) : [-117.81, 34.03],
            minZoom: params.get("minZoom") ? parseInt(params.get("minZoom")) : 10,
            maxZoom: params.get("maxZoom") ? parseInt(params.get("maxZoom")) : 13,
            extent: params.get("extent") ? params.get("extent").split(",").map(Number) : null
          };
        }

        // Get parameters from the URL
        const params = getUrlParams();

        // Function to fetch and parse CSV
        function fetchApiKey(project) {
          return fetch('api-keys.csv')
            .then(response => {
              if (!response.ok) throw new Error('Could not load api-keys.csv');
              return response.text();
            })
            .then(text => {
              const lines = text.trim().split(/\r?\n/);
              const headers = lines[0].split(',');
              for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                const rowObj = {};
                headers.forEach((h, idx) => rowObj[h.trim()] = row[idx] ? row[idx].trim() : '');
                if (rowObj['Client'] && rowObj['Client'].toLowerCase() === project.toLowerCase()) {
                  return rowObj['API Key'];
                }
              }
              throw new Error('Project not found in api-keys.csv');
            });
        }

        // Main logic: fetch API key, then initialize map
        fetchApiKey(params.project || '').then(apiKey => {
          esriConfig.apiKey = apiKey;

          // Create a WebMap using the item-id
          const webMap = new WebMap({
            portalItem: {
              id: params.itemId || "e5c39104355f4a749e5550bc083c1ff6" // Default item ID
            }
          });

          // Define the extent if provided
          const restrictedExtent = params.extent
            ? new Extent({
                xmin: params.extent[0],
                ymin: params.extent[1],
                xmax: params.extent[2],
                ymax: params.extent[3],
                spatialReference: { wkid: 4326 }
              })
            : null;

          // Create the view (center/zoom will be set after map loads if not provided)
          const view = new MapView({
            container: "viewDiv",
            map: webMap,
            constraints: {
              rotationEnabled: false // Optional: Disable map rotation
            }
          });

          // After the web map loads, set min/max zoom based on the default zoom
          webMap.when().then(() => {
            view.when(() => {
              const defaultZoom = view.zoom;
              view.constraints.minZoom = defaultZoom - 2;
              view.constraints.maxZoom = defaultZoom + 4;
              // Seamlessly set panning constraint at minZoom
              const originalZoom = view.zoom;
              view.goTo({ zoom: view.constraints.minZoom }, { animate: false }).then(() => {
                const minZoomExtent = view.extent.clone();
                view.constraints.geometry = minZoomExtent;
                return view.goTo({ zoom: originalZoom }, { animate: false });
              });
            });
          });

          // Bind the map view to the scale bar web component
          const webScaleBar = document.getElementById("webScaleBar");
          view.when().then(() => {
            webScaleBar.setAttribute("unit", "imperial");
            webScaleBar.setAttribute("bar-style", "ruler");
            webScaleBar.view = view;
          });
          // Move the scale bar to the bottom-left in the map UI
          view.ui.add(webScaleBar, "bottom-left");

          // Add the legend widget to the drawer
          const legend = new Legend({
            view: view
          });
          legend.container = "legendContent"; // Attach the legend to the drawer

          // Remove old legend drawer/toggle logic and use Calcite actions
          const legendPanel = document.getElementById("legendPanel");
          const collapseLegend = document.getElementById("collapseLegend");
          const expandLegend = document.getElementById("expandLegend");
          collapseLegend.addEventListener("click", function () {
            legendPanel.hidden = true;
            expandLegend.style.display = "block";
            expandLegend.focus();
          });
          expandLegend.addEventListener("click", function () {
            legendPanel.hidden = false;
            expandLegend.style.display = "none";
          });

          // Remove previous manual positioning for expandLegend
          // Add expandLegend to the map's UI for perfect alignment
          view.ui.add(expandLegend, "top-left");
          // Place the legend panel inside the map view container for proper stacking
          const viewDiv = document.getElementById("viewDiv");
          viewDiv.appendChild(legendPanel);
        }).catch(err => {
          alert('Error loading API key for client: ' + err.message);
        });
      });
    </script>
  </body>
</html>
